{"ast":null,"code":"import _extends from \"@babel/runtime/helpers/esm/extends\";\nimport _objectWithoutPropertiesLoose from \"@babel/runtime/helpers/esm/objectWithoutPropertiesLoose\";\nimport React, { useRef, useState, useCallback, useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport omit from 'lodash/omit';\nimport pick from 'lodash/pick';\nimport isNil from 'lodash/isNil';\nimport isFunction from 'lodash/isFunction';\nimport shallowEqual from '../utils/shallowEqual';\nimport DropdownMenu from './DropdownMenu';\nimport { findNodeOfTree, flattenTree, getNodeParents } from '../utils/treeUtils';\nimport { usePaths } from './utils';\nimport { getSafeRegExpString, createChainedFunction, mergeRefs, useControlled, useCustom, useClassNames } from '../utils';\nimport { PickerToggle, PickerOverlay, SearchBar, PickerToggleTrigger, usePickerClassName, usePublicMethods, useToggleKeyDownEvent, useFocusItemValue, pickTriggerPropKeys, omitTriggerPropKeys, listPickerPropTypes } from '../Picker';\nvar emptyArray = [];\nvar Cascader = /*#__PURE__*/React.forwardRef(function (props, ref) {\n  var _props$as = props.as,\n      Component = _props$as === void 0 ? 'div' : _props$as,\n      _props$data = props.data,\n      data = _props$data === void 0 ? emptyArray : _props$data,\n      _props$classPrefix = props.classPrefix,\n      classPrefix = _props$classPrefix === void 0 ? 'picker' : _props$classPrefix,\n      _props$childrenKey = props.childrenKey,\n      childrenKey = _props$childrenKey === void 0 ? 'children' : _props$childrenKey,\n      _props$valueKey = props.valueKey,\n      valueKey = _props$valueKey === void 0 ? 'value' : _props$valueKey,\n      _props$labelKey = props.labelKey,\n      labelKey = _props$labelKey === void 0 ? 'label' : _props$labelKey,\n      defaultValue = props.defaultValue,\n      placeholder = props.placeholder,\n      disabled = props.disabled,\n      _props$disabledItemVa = props.disabledItemValues,\n      disabledItemValues = _props$disabledItemVa === void 0 ? emptyArray : _props$disabledItemVa,\n      _props$appearance = props.appearance,\n      appearance = _props$appearance === void 0 ? 'default' : _props$appearance,\n      _props$cleanable = props.cleanable,\n      cleanable = _props$cleanable === void 0 ? true : _props$cleanable,\n      overrideLocale = props.locale,\n      toggleAs = props.toggleAs,\n      style = props.style,\n      valueProp = props.value,\n      inline = props.inline,\n      menuClassName = props.menuClassName,\n      menuStyle = props.menuStyle,\n      menuWidth = props.menuWidth,\n      menuHeight = props.menuHeight,\n      _props$searchable = props.searchable,\n      searchable = _props$searchable === void 0 ? true : _props$searchable,\n      parentSelectable = props.parentSelectable,\n      _props$placement = props.placement,\n      placement = _props$placement === void 0 ? 'bottomStart' : _props$placement,\n      id = props.id,\n      renderMenuItem = props.renderMenuItem,\n      renderSearchItem = props.renderSearchItem,\n      renderValue = props.renderValue,\n      renderMenu = props.renderMenu,\n      renderExtraFooter = props.renderExtraFooter,\n      onEnter = props.onEnter,\n      onExited = props.onExited,\n      onClean = props.onClean,\n      onChange = props.onChange,\n      onSelect = props.onSelect,\n      onSearch = props.onSearch,\n      onClose = props.onClose,\n      onOpen = props.onOpen,\n      getChildren = props.getChildren,\n      rest = _objectWithoutPropertiesLoose(props, [\"as\", \"data\", \"classPrefix\", \"childrenKey\", \"valueKey\", \"labelKey\", \"defaultValue\", \"placeholder\", \"disabled\", \"disabledItemValues\", \"appearance\", \"cleanable\", \"locale\", \"toggleAs\", \"style\", \"value\", \"inline\", \"menuClassName\", \"menuStyle\", \"menuWidth\", \"menuHeight\", \"searchable\", \"parentSelectable\", \"placement\", \"id\", \"renderMenuItem\", \"renderSearchItem\", \"renderValue\", \"renderMenu\", \"renderExtraFooter\", \"onEnter\", \"onExited\", \"onClean\", \"onChange\", \"onSelect\", \"onSearch\", \"onClose\", \"onOpen\", \"getChildren\"]); // Use component active state to support keyboard events.\n\n\n  var _useState = useState(false),\n      active = _useState[0],\n      setActive = _useState[1];\n\n  var _useState2 = useState(flattenTree(data, childrenKey)),\n      flattenData = _useState2[0],\n      setFlattenData = _useState2[1];\n\n  var triggerRef = useRef(null);\n  var overlayRef = useRef(null);\n  var targetRef = useRef(null);\n  var searchInputRef = useRef(null);\n\n  var _ref = useControlled(valueProp, defaultValue),\n      value = _ref[0],\n      setValue = _ref[1];\n\n  var _usePaths = usePaths({\n    data: data,\n    valueKey: valueKey,\n    childrenKey: childrenKey,\n    value: value\n  }),\n      selectedPaths = _usePaths.selectedPaths,\n      valueToPaths = _usePaths.valueToPaths,\n      columnData = _usePaths.columnData,\n      addColumn = _usePaths.addColumn,\n      setValueToPaths = _usePaths.setValueToPaths,\n      setColumnData = _usePaths.setColumnData,\n      setSelectedPaths = _usePaths.setSelectedPaths,\n      enforceUpdate = _usePaths.enforceUpdate;\n\n  useEffect(function () {\n    setFlattenData(flattenTree(data, childrenKey));\n  }, [data, childrenKey]);\n  usePublicMethods(ref, {\n    triggerRef: triggerRef,\n    overlayRef: overlayRef,\n    targetRef: targetRef\n  });\n\n  var _useCustom = useCustom('Picker', overrideLocale),\n      locale = _useCustom.locale,\n      rtl = _useCustom.rtl;\n  /**\n   * 1.Have a value and the value is valid.\n   * 2.Regardless of whether the value is valid, as long as renderValue is set, it is judged to have a value.\n   */\n\n\n  var hasValue = valueToPaths.length > 0 || !isNil(value) && isFunction(renderValue);\n\n  var _useClassNames = useClassNames(classPrefix),\n      prefix = _useClassNames.prefix,\n      merge = _useClassNames.merge;\n\n  var _useState3 = useState(''),\n      searchKeyword = _useState3[0],\n      setSearchKeyword = _useState3[1];\n\n  var someKeyword = useCallback(function (item, keyword) {\n    if (item[labelKey].match(new RegExp(getSafeRegExpString(keyword || searchKeyword), 'i'))) {\n      return true;\n    }\n\n    if (item.parent && someKeyword(item.parent)) {\n      return true;\n    }\n\n    return false;\n  }, [labelKey, searchKeyword]);\n  var getSearchResult = useCallback(function (keyword) {\n    var items = [];\n    var result = flattenData.filter(function (item) {\n      if (!parentSelectable && item[childrenKey]) {\n        return false;\n      }\n\n      return someKeyword(item, keyword);\n    });\n\n    for (var i = 0; i < result.length; i++) {\n      items.push(result[i]); // A maximum of 100 search results are returned.\n\n      if (i === 99) {\n        return items;\n      }\n    }\n\n    return items;\n  }, [childrenKey, flattenData, someKeyword, parentSelectable]); // Used to hover the focuse item  when trigger `onKeydown`\n\n  var _useFocusItemValue = useFocusItemValue(value, {\n    rtl: rtl,\n    data: flattenData,\n    valueKey: valueKey,\n    defaultLayer: valueToPaths !== null && valueToPaths !== void 0 && valueToPaths.length ? valueToPaths.length - 1 : 0,\n    target: function target() {\n      return overlayRef.current;\n    },\n    callback: useCallback(function (value) {\n      enforceUpdate(value, true);\n    }, [enforceUpdate])\n  }),\n      focusItemValue = _useFocusItemValue.focusItemValue,\n      setFocusItemValue = _useFocusItemValue.setFocusItemValue,\n      setLayer = _useFocusItemValue.setLayer,\n      setKeys = _useFocusItemValue.setKeys,\n      onFocusItem = _useFocusItemValue.onKeyDown;\n\n  var handleSearch = useCallback(function (value, event) {\n    var items = getSearchResult(value);\n    setSearchKeyword(value);\n    onSearch === null || onSearch === void 0 ? void 0 : onSearch(value, event);\n\n    if (items.length > 0) {\n      setFocusItemValue(items[0][valueKey]);\n      setLayer(0);\n      setKeys([]);\n    }\n  }, [getSearchResult, onSearch, setFocusItemValue, setKeys, setLayer, valueKey]);\n  var handleEntered = useCallback(function () {\n    if (!targetRef.current) {\n      return;\n    }\n\n    onOpen === null || onOpen === void 0 ? void 0 : onOpen();\n    setActive(true);\n  }, [onOpen]);\n  var handleExited = useCallback(function () {\n    if (!targetRef.current) {\n      return;\n    }\n\n    onClose === null || onClose === void 0 ? void 0 : onClose();\n    setActive(false);\n    setSearchKeyword('');\n  }, [onClose]);\n  var handleClose = useCallback(function () {\n    var _triggerRef$current;\n\n    (_triggerRef$current = triggerRef.current) === null || _triggerRef$current === void 0 ? void 0 : _triggerRef$current.close();\n  }, [triggerRef]);\n  var handleClean = useCallback(function (event) {\n    if (disabled || !targetRef.current) {\n      return;\n    }\n\n    setColumnData([data]);\n    setValue(null);\n    setSelectedPaths([]);\n    setValueToPaths([]);\n    onChange === null || onChange === void 0 ? void 0 : onChange(null, event);\n  }, [data, disabled, onChange, setSelectedPaths, setColumnData, setValueToPaths, setValue]);\n  var handleMenuPressEnter = useCallback(function (event) {\n    var focusItem = findNodeOfTree(data, function (item) {\n      return item[valueKey] === focusItemValue;\n    });\n    var isLeafNode = focusItem && !focusItem[childrenKey];\n\n    if (isLeafNode) {\n      setValue(focusItemValue);\n      setValueToPaths(selectedPaths);\n\n      if (selectedPaths.length) {\n        setLayer(selectedPaths.length - 1);\n      }\n\n      if (!shallowEqual(value, focusItemValue)) {\n        onChange === null || onChange === void 0 ? void 0 : onChange(focusItemValue !== null && focusItemValue !== void 0 ? focusItemValue : null, event);\n      }\n\n      handleClose();\n    }\n  }, [childrenKey, data, focusItemValue, handleClose, onChange, selectedPaths, setLayer, setValue, setValueToPaths, value, valueKey]);\n  var onPickerKeyDown = useToggleKeyDownEvent(_extends({\n    toggle: !focusItemValue || !active,\n    triggerRef: triggerRef,\n    targetRef: targetRef,\n    overlayRef: overlayRef,\n    searchInputRef: searchInputRef,\n    active: active,\n    onExit: handleClean,\n    onMenuKeyDown: onFocusItem,\n    onMenuPressEnter: handleMenuPressEnter\n  }, rest));\n\n  var handleSelect = function handleSelect(node, cascadePaths, isLeafNode, event) {\n    var _node$childrenKey, _node$childrenKey2, _triggerRef$current2;\n\n    var nextValue = node[valueKey];\n    onSelect === null || onSelect === void 0 ? void 0 : onSelect(node, cascadePaths, event);\n    setSelectedPaths(cascadePaths); // Lazy load node's children\n\n    if (typeof getChildren === 'function' && ((_node$childrenKey = node[childrenKey]) === null || _node$childrenKey === void 0 ? void 0 : _node$childrenKey.length) === 0) {\n      node.loading = true;\n      var children = getChildren(node);\n\n      if (children instanceof Promise) {\n        children.then(function (data) {\n          node.loading = false;\n          node[childrenKey] = data;\n\n          if (targetRef.current) {\n            addColumn(data, cascadePaths.length);\n          }\n        });\n      } else {\n        node.loading = false;\n        node[childrenKey] = children;\n        addColumn(children, cascadePaths.length);\n      }\n    } else if ((_node$childrenKey2 = node[childrenKey]) !== null && _node$childrenKey2 !== void 0 && _node$childrenKey2.length) {\n      addColumn(node[childrenKey], cascadePaths.length);\n    }\n\n    if (isLeafNode) {\n      // Determines whether the option is a leaf node, and if so, closes the picker.\n      handleClose(); // Update the selected path to the value path.\n      // That is, the selected path will be displayed on the button after clicking the child node.\n\n      setValueToPaths(cascadePaths);\n      setValue(nextValue);\n\n      if (!shallowEqual(value, nextValue)) {\n        onChange === null || onChange === void 0 ? void 0 : onChange(nextValue, event);\n      }\n\n      return;\n    }\n    /** When the parent is optional, the value and the displayed path are updated. */\n\n\n    if (parentSelectable && !shallowEqual(value, nextValue)) {\n      setValue(nextValue);\n      onChange === null || onChange === void 0 ? void 0 : onChange(nextValue, event);\n      setValueToPaths(cascadePaths);\n    } // Update menu position\n\n\n    (_triggerRef$current2 = triggerRef.current) === null || _triggerRef$current2 === void 0 ? void 0 : _triggerRef$current2.updatePosition();\n  };\n  /**\n   * The search structure option is processed after being selected.\n   */\n\n\n  var handleSearchRowSelect = function handleSearchRowSelect(node, nodes, event) {\n    var nextValue = node[valueKey];\n    handleClose();\n    setSearchKeyword('');\n    setValue(nextValue);\n    setValueToPaths(nodes);\n    enforceUpdate(nextValue);\n    onSelect === null || onSelect === void 0 ? void 0 : onSelect(node, nodes, event);\n    onChange === null || onChange === void 0 ? void 0 : onChange(nextValue, event);\n  };\n\n  var renderSearchRow = function renderSearchRow(item, key) {\n    var regx = new RegExp(getSafeRegExpString(searchKeyword), 'ig');\n    var nodes = getNodeParents(item);\n    nodes.push(item);\n    var formattedNodes = nodes.map(function (node) {\n      var _extends2;\n\n      var labelElements = [];\n      var a = node[labelKey].split(regx);\n      var b = node[labelKey].match(regx);\n\n      for (var i = 0; i < a.length; i++) {\n        labelElements.push(a[i]);\n\n        if (b && b[i]) {\n          labelElements.push( /*#__PURE__*/React.createElement(\"span\", {\n            key: i,\n            className: prefix('cascader-search-match')\n          }, b[i]));\n        }\n      }\n\n      return _extends({}, node, (_extends2 = {}, _extends2[labelKey] = labelElements, _extends2));\n    });\n    var disabled = disabledItemValues.some(function (value) {\n      return formattedNodes.some(function (node) {\n        return node[valueKey] === value;\n      });\n    });\n    var itemClasses = prefix('cascader-row', {\n      'cascader-row-disabled': disabled,\n      'cascader-row-focus': item[valueKey] === focusItemValue\n    });\n    var label = formattedNodes.map(function (node, index) {\n      return /*#__PURE__*/React.createElement(\"span\", {\n        key: \"col-\" + index,\n        className: prefix('cascader-col')\n      }, node[labelKey]);\n    });\n    return /*#__PURE__*/React.createElement(\"div\", {\n      key: key,\n      \"aria-disabled\": disabled,\n      \"data-key\": item[valueKey],\n      className: itemClasses,\n      onClick: function onClick(event) {\n        if (!disabled) {\n          handleSearchRowSelect(item, nodes, event);\n        }\n      }\n    }, renderSearchItem ? renderSearchItem(label, nodes) : label);\n  };\n\n  var renderSearchResultPanel = function renderSearchResultPanel() {\n    if (searchKeyword === '') {\n      return null;\n    }\n\n    var items = getSearchResult();\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: prefix('cascader-search-panel'),\n      \"data-layer\": 0\n    }, items.length ? items.map(renderSearchRow) : /*#__PURE__*/React.createElement(\"div\", {\n      className: prefix('none')\n    }, locale.noResultsText));\n  };\n\n  var renderDropdownMenu = function renderDropdownMenu(positionProps, speakerRef) {\n    var _ref2 = positionProps || {},\n        left = _ref2.left,\n        top = _ref2.top,\n        className = _ref2.className;\n\n    var styles = _extends({}, menuStyle, {\n      left: left,\n      top: top\n    });\n\n    var classes = merge(className, menuClassName, prefix('cascader-menu', {\n      inline: inline\n    }));\n    return /*#__PURE__*/React.createElement(PickerOverlay, {\n      ref: mergeRefs(overlayRef, speakerRef),\n      className: classes,\n      style: styles,\n      target: triggerRef,\n      onKeyDown: onPickerKeyDown\n    }, searchable && /*#__PURE__*/React.createElement(SearchBar, {\n      placeholder: locale === null || locale === void 0 ? void 0 : locale.searchPlaceholder,\n      onChange: handleSearch,\n      value: searchKeyword,\n      inputRef: searchInputRef\n    }), renderSearchResultPanel(), searchKeyword === '' && /*#__PURE__*/React.createElement(DropdownMenu, {\n      id: id ? id + \"-listbox\" : undefined,\n      menuWidth: menuWidth,\n      menuHeight: menuHeight,\n      disabledItemValues: disabledItemValues,\n      valueKey: valueKey,\n      labelKey: labelKey,\n      childrenKey: childrenKey,\n      classPrefix: 'picker-cascader-menu',\n      cascadeData: columnData,\n      cascadePaths: selectedPaths,\n      activeItemValue: value,\n      onSelect: handleSelect,\n      renderMenu: renderMenu,\n      renderMenuItem: renderMenuItem\n    }), renderExtraFooter === null || renderExtraFooter === void 0 ? void 0 : renderExtraFooter());\n  };\n\n  var selectedElement = placeholder;\n\n  if (valueToPaths.length > 0) {\n    selectedElement = [];\n    valueToPaths.forEach(function (item, index) {\n      var key = item[valueKey] || item[labelKey];\n      selectedElement.push( /*#__PURE__*/React.createElement(\"span\", {\n        key: key\n      }, item[labelKey]));\n\n      if (index < valueToPaths.length - 1) {\n        selectedElement.push( /*#__PURE__*/React.createElement(\"span\", {\n          className: \"separator\",\n          key: key + \"-separator\"\n        }, ' / '));\n      }\n    });\n  }\n\n  if (!isNil(value) && isFunction(renderValue)) {\n    selectedElement = renderValue(value, valueToPaths, selectedElement); // If renderValue returns null or undefined, hasValue is false.\n\n    if (isNil(selectedElement)) {\n      hasValue = false;\n    }\n  }\n\n  var _usePickerClassName = usePickerClassName(_extends({}, props, {\n    classPrefix: classPrefix,\n    hasValue: hasValue,\n    name: 'cascader',\n    appearance: appearance,\n    cleanable: cleanable\n  })),\n      classes = _usePickerClassName[0],\n      usedClassNamePropKeys = _usePickerClassName[1]; // TODO: bad api design\n  //       consider an isolated Menu component\n\n\n  if (inline) {\n    return renderDropdownMenu();\n  }\n\n  return /*#__PURE__*/React.createElement(PickerToggleTrigger, {\n    pickerProps: pick(props, pickTriggerPropKeys),\n    ref: triggerRef,\n    placement: placement,\n    onEntered: createChainedFunction(handleEntered, onEnter),\n    onExited: createChainedFunction(handleExited, onExited),\n    speaker: renderDropdownMenu\n  }, /*#__PURE__*/React.createElement(Component, {\n    className: classes,\n    style: style\n  }, /*#__PURE__*/React.createElement(PickerToggle, _extends({}, omit(rest, [].concat(omitTriggerPropKeys, usedClassNamePropKeys)), {\n    id: id,\n    ref: targetRef,\n    as: toggleAs,\n    appearance: appearance,\n    disabled: disabled,\n    onClean: createChainedFunction(handleClean, onClean),\n    onKeyDown: onPickerKeyDown,\n    cleanable: cleanable && !disabled,\n    hasValue: hasValue,\n    active: active,\n    placement: placement,\n    inputValue: value !== null && value !== void 0 ? value : ''\n  }), selectedElement || (locale === null || locale === void 0 ? void 0 : locale.placeholder))));\n});\nCascader.displayName = 'Cascader';\nCascader.propTypes = _extends({}, listPickerPropTypes, {\n  disabledItemValues: PropTypes.array,\n  locale: PropTypes.any,\n  appearance: PropTypes.oneOf(['default', 'subtle']),\n  renderMenu: PropTypes.func,\n  onSelect: PropTypes.func,\n  onSearch: PropTypes.func,\n  cleanable: PropTypes.bool,\n  renderMenuItem: PropTypes.func,\n  renderSearchItem: PropTypes.func,\n  menuWidth: PropTypes.number,\n  menuHeight: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  searchable: PropTypes.bool,\n  inline: PropTypes.bool,\n  parentSelectable: PropTypes.bool\n});\nexport default Cascader;","map":null,"metadata":{},"sourceType":"module"}